<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SELELO BUSINESS PARK</title>
  <meta name="description" content="Secure business tracker with offline support and cloud sync">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Selelo Business Park\",
    \"short_name\": \"Selelo\",
    \"description\": \"Business transaction tracker\",
    \"start_url\": \".\",
    \"display\": \"standalone\",
    \"background_color\": \"#1A120B\",
    \"theme_color\": \"#E2725B\",
    \"icons\": [
      {\"src\": \"11.png\", \"sizes\": \"192x192\", \"type\": \"image/png\"},
      {\"src\": \"11.png\", \"sizes\": \"512x512\", \"type\": \"image/png\"}
    ]
  }">
  <style>
    :root {
      --bg-dark: #1A120B; --muted: #A89A8F; --text: #F8F4F0;
      --accent1: #E2725B; --accent2: #D4A574; --good: #4ade80; --danger: #D9534F;
      --radius: 14px; --maxw: 1200px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui; color: var(--text); -webkit-font-smoothing: antialiased; }
    body { background: var(--bg-dark) url('2.png') center/cover fixed; min-height: 100vh; }
    body::before { content: ""; position: fixed; inset: 0; background: linear-gradient(180deg, rgba(26,18,11,0.6), rgba(0,0,0,0.4)); backdrop-filter: blur(2px); z-index: -1; }
    .shell { padding: 28px; display: flex; justify-content: center; min-height: 100vh; }
    .card { max-width: var(--maxw); width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); backdrop-filter: blur(8px); display: flex; flex-direction: column; gap: 16px; }
    h1 { margin: 0; font-size: 24px; font-weight: 800; text-transform: uppercase; animation: subtleGlow 2s ease-in-out infinite alternate; }
    @keyframes subtleGlow { from { text-shadow: 0 0 4px rgba(226,114,91,0.3); } to { text-shadow: 0 0 8px rgba(212,165,116,0.4); } }
    .sub { color: var(--muted); font-size: 13px; }
    .btn { padding: 10px 14px; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .btn-admin, .btn-add { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #042; box-shadow: 0 4px 16px rgba(226,114,91,0.2); }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: var(--text); }
    .grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .panel { background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); }
    .admin-panel.admin-active { background: linear-gradient(180deg, rgba(226,114,91,0.08), rgba(212,165,116,0.05)); border-color: rgba(226,114,91,0.15); }
    .fields { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .field { flex: 1; min-width: 140px; display: flex; flex-direction: column; gap: 6px; }
    input, select, textarea { background: transparent; border: 1px solid rgba(255,255,255,0.08); padding: 10px 12px; border-radius: 10px; color: var(--text); }
    input:focus, select:focus, textarea:focus { border-color: var(--accent1); box-shadow: 0 0 0 3px rgba(226,114,91,0.1); outline: none; }
    .table-wrap { margin-top: 12px; overflow-x: auto; border-radius: 10px; }
    table { width: 100%; min-width: 640px; border-collapse: collapse; }
    th { padding: 10px; text-align: left; color: var(--muted); border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 14px; }
    .action-btn { background: linear-gradient(90deg, var(--accent1), var(--accent2)); color: #001; padding: 6px 8px; border-radius: 8px; font-weight: 700; }
    .delete-btn { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 6px 8px; border-radius: 8px; }
    .delete-btn:hover { background: var(--danger); color: #fff; }
    .stat { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.08); transition: 0.2s; }
    .stat:hover { background: linear-gradient(180deg, rgba(212,165,116,0.1), transparent); transform: translateY(-2px); }
    .modal { position: fixed; top: 7%; left: 50%; transform: translateX(-50%); width: 94%; max-width: 460px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); padding: 16px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); backdrop-filter: blur(8px); display: none; z-index: 1300; }
    .modal.show { display: block; animation: drop 240ms ease; }
    @keyframes drop { from { opacity: 0; transform: translateX(-50%) translateY(-8px); } to { opacity: 1; transform: translateX(-50%); } }
    .receipt { background: #fff; color: #000; padding: 16px; border-radius: 8px; }
    footer { text-align: center; color: var(--muted); font-size: 13px; padding: 16px 0; margin-top: auto; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .back-to-top { position: fixed; bottom: 20px; right: 20px; background: var(--accent1); color: #fff; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; z-index: 1000; }
    .back-to-top.show { display: block; }

    /* RESPONSIVE & FOLDABLE */
    @media (max-width: 640px) {
      .card { padding: 16px; }
      table { min-width: 100%; font-size: 12px; }
      th, td { padding: 6px 4px; white-space: nowrap; }
      td:nth-child(5) { white-space: normal; word-break: break-word; }
    }
    .foldable { cursor: pointer; }
    .foldable::after { content: "Down Arrow"; float: right; font-size: 12px; }
    .foldable.collapsed::after { content: "Right Arrow"; }
    .transactions-table { display: none; }
    .transactions-table.show { display: table; }
  </style>
</head>
<body>
  <div class="shell">
    <main class="card">
      <div class="top">
        <div class="brand">
          <img src="11.png" class="logo" alt="logo" onerror="this.style.display='none'">
          <div>
            <h1>SELELO BUSINESS PARK</h1>
            <div class="sub">The BizHub</div>
          </div>
        </div>
        <div class="controls">
          <button id="adminBtn" class="btn btn-admin">Admin Login</button>
          <button id="themeBtn" class="btn btn-theme">Toggle Theme</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportCsv" class="btn btn-theme">Export CSV</button>
        <button id="genPL" class="btn btn-theme">Generate P&L</button>
        <button id="downloadPL" class="btn btn-admin">Download P&L</button>
      </div>
      <div class="grid">
        <section>
          <div id="addPanel" class="panel admin-panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h2 style="margin:0;font-size:16px">Add Transaction</h2>
                <div class="sub">Sign in as admin to add, edit or delete</div>
              </div>
              <div id="adminBadgeWrap"></div>
            </div>
            <div class="fields">
              <div class="field"><label for="txDate">Date</label><input id="txDate" type="date"></div>
              <div class="field"><label for="txType">Type</label><select id="txType"><option>Income</option><option>Expense</option></select></div>
              <div class="field"><label for="txCategory">Category</label><select id="txCategory"><option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option></select></div>
              <div class="field"><label for="txAmount">Amount</label><input id="txAmount" type="number" min="0" step="0.01" placeholder="0.00"></div>
            </div>
            <div style="margin-top:10px"><label for="txNotes">Notes</label><textarea id="txNotes" placeholder="Optional notes..."></textarea></div>
            <div class="actions">
              <button id="addBtn" class="btn-add" disabled>Add Transaction</button>
              <button id="clearBtn" class="btn-ghost">Clear</button>
              <div id="txMsg" class="sub" style="margin-left:6px;color:var(--good)"></div>
            </div>
          </div>
          <div class="panel" style="margin-top:12px" id="transactionsPanel">
            <div style="display:flex;justify-content:space-between;align-items:center" class="foldable" id="txFold">
              <h3 style="margin:0">Transactions</h3><div class="sub">Click to expand/collapse</div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <input id="fMonth" type="month" style="min-width:160px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
              <select id="fType" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)"><option value="">All Types</option><option>Income</option><option>Expense</option></select>
              <select id="fCategory" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)"><option value="">All Categories</option><option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option></select>
              <input id="fMin" type="number" placeholder="Min" style="width:100px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
              <input id="fMax" type="number" placeholder="Max" style="width:100px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
              <input id="fNotes" type="text" placeholder="Notes contains" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
              <button id="applyFilter" class="btn btn-ghost">Apply</button>
              <button id="resetFilter" class="btn btn-ghost">Reset</button>
            </div>
            <div class="table-wrap" style="margin-top:12px">
              <table aria-label="transactions table" class="transactions-table" id="txTable">
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Notes</th><th>Action</th></tr></thead>
                <tbody id="txTbody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <aside>
          <div class="panel dashboard">
            <h3 style="margin:0">Overview</h3>
            <div class="stat-grid">
              <div class="stat"><h4>Total Income</h4><p id="statIncome">0</p></div>
              <div class="stat"><h4>Total Expense</h4><p id="statExpense">0</p></div>
              <div class="stat"><h4>Balance</h4><p id="statBalance">0</p></div>
            </div>
            <div id="budgetAlert" class="sub" style="margin-top:8px;color:var(--danger)"></div>
          </div>
          <div id="chartsPanel" class="panel charts" aria-hidden="true" style="margin-top:12px">
            <h3 style="margin:0">Charts</h3>
            <div style="margin-top:8px"><canvas id="chartIE" height="140"></canvas></div>
            <div style="margin-top:8px"><canvas id="chartCat" height="140"></canvas></div>
            <div style="margin-top:8px"><canvas id="chartTrend" height="140"></canvas></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h3 style="margin:0">Profit & Loss</h3>
            <label for="reportMonth" class="sub" style="display:block;margin-top:8px">Month (optional)</label>
            <input id="reportMonth" type="month" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="showPLBtn" class="btn btn-ghost">Show</button>
              <button id="downloadPLBtn" class="btn btn-admin">Download</button>
            </div>
            <div id="plView" style="margin-top:10px;color:var(--muted);font-size:13px"></div>
          </div>
        </aside>
      </div>
      <footer>Proudly developed by Seltec | +254745151968 | @Its_SelianFr</footer>
    </main>
  </div>

  <!-- Back to Top -->
  <button class="back-to-top" id="backToTop">Up Arrow</button>

  <!-- Modals -->
  <div id="adminModal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-panel">
      <h3>Administrator access</h3>
      <p>Enter admin password to unlock add/edit/delete. Session stored locally on this device.</p>
      <input id="adminPassword" type="password" placeholder="Admin password" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text)">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="adminCancel" class="btn btn-ghost">Cancel</button>
        <button id="adminConfirm" class="btn btn-admin">Confirm</button>
      </div>
    </div>
  </div>
  <div id="editModal" class="modal" aria-hidden="true" style="top:40%;transform:translateX(-50%) translateY(-50%)">
    <div class="modal-panel">
      <h3>Edit Transaction</h3>
      <label style="font-size:13px;color:var(--muted)">Date</label><input id="editDate" type="date" style="width:100%;padding:10px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
      <label style="font-size:13px;color:var(--muted);margin-top:8px">Type</label><select id="editType" style="width:100%;padding:10px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)"><option>Income</option><option>Expense</option></select>
      <label style="font-size:13px;color:var(--muted);margin-top:8px">Category</label><select id="editCategory" style="width:100%;padding:10px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)"><option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option></select>
      <label style="font-size:13px;color:var(--muted);margin-top:8px">Amount</label><input id="editAmount" type="number" style="width:100%;padding:10px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)">
      <label style="font-size:13px;color:var(--muted);margin-top:8px">Notes</label><textarea id="editNotes" style="width:100%;padding:10px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)"></textarea>
      <div style="text-align:right;margin-top:10px">
        <button id="editCancelBtn" class="btn btn-ghost">Cancel</button>
        <button id="editSaveBtn" class="btn btn-admin">Save</button>
      </div>
    </div>
  </div>
  <div id="receiptModal" class="modal" aria-hidden="true" style="top:8%;transform:translateX(-50%)">
    <div class="modal-panel" id="receiptInner"></div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript,/* minimal SW */self.addEventListener("install",e=>e.waitUntil(self.skipWaiting()));self.addEventListener("activate",e=>e.waitUntil(self.clients.claim()));');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyD1IrZScZZOZXEkWBM8WUDhKrnSTM89TIY",
        authDomain: "selelo-tracker.firebaseapp.com",
        projectId: "selelo-tracker",
        storageBucket: "selelo-tracker.firebasestorage.app",
        messagingSenderId: "42660826905",
        appId: "1:42660826905:web:b3074d71e00e2e0b9fbf88"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const txRef = db.ref('transactions');

      const KEY_TX = "selelo_tx_local", KEY_ADMIN = "selelo_admin_final", KEY_THEME = "selelo_theme_final";
      const ADMIN_PASSWORDS = ["0742147197","0721235005"];
      let transactions = JSON.parse(localStorage.getItem(KEY_TX) || "[]");
      let isAdmin = localStorage.getItem(KEY_ADMIN) === "true";
      let editKey = null, chartIE, chartCat, chartTrend, usingFirebase = true;

      const els = {
        adminBtn: document.getElementById('adminBtn'), addBtn: document.getElementById('addBtn'), clearBtn: document.getElementById('clearBtn'),
        txDate: document.getElementById('txDate'), txType: document.getElementById('txType'), txCategory: document.getElementById('txCategory'),
        txAmount: document.getElementById('txAmount'), txNotes: document.getElementById('txNotes'), txMsg: document.getElementById('txMsg'),
        txTbody: document.getElementById('txTbody'), fMonth: document.getElementById('fMonth'), fType: document.getElementById('fType'),
        fCategory: document.getElementById('fCategory'), fMin: document.getElementById('fMin'), fMax: document.getElementById('fMax'),
        fNotes: document.getElementById('fNotes'), applyFilter: document.getElementById('applyFilter'), resetFilter: document.getElementById('resetFilter'),
        statIncome: document.getElementById('statIncome'), statExpense: document.getElementById('statExpense'), statBalance: document.getElementById('statBalance'),
        adminBadgeWrap: document.getElementById('adminBadgeWrap'), chartsPanel: document.getElementById('chartsPanel'),
        adminModal: document.getElementById('adminModal'), adminPassword: document.getElementById('adminPassword'),
        adminCancel: document.getElementById('adminCancel'), adminConfirm: document.getElementById('adminConfirm'),
        editModal: document.getElementById('editModal'), editDate: document.getElementById('editDate'), editType: document.getElementById('editType'),
        editCategory: document.getElementById('editCategory'), editAmount: document.getElementById('editAmount'), editNotes: document.getElementById('editNotes'),
        editCancelBtn: document.getElementById('editCancelBtn'), editSaveBtn: document.getElementById('editSaveBtn'),
        receiptModal: document.getElementById('receiptModal'), receiptInner: document.getElementById('receiptInner'),
        exportCsv: document.getElementById('exportCsv'), genPL: document.getElementById('genPL'), downloadPL: document.getElementById('downloadPL'),
        reportMonth: document.getElementById('reportMonth'), showPLBtn: document.getElementById('showPLBtn'), plView: document.getElementById('plView'),
        addPanel: document.getElementById('addPanel'), txFold: document.getElementById('txFold'), txTable: document.getElementById('txTable'),
        backToTop: document.getElementById('backToTop')
      };

      function saveLocal() { localStorage.setItem(KEY_TX, JSON.stringify(transactions)); }
      function setAdmin(v) { isAdmin = !!v; localStorage.setItem(KEY_ADMIN, isAdmin ? "true" : "false"); applyAdminUI(); }
      function openModal(el) { el.classList.add('show'); el.style.display = 'block'; el.setAttribute('aria-hidden', 'false'); }
      function closeModal(el) { el.classList.remove('show'); el.style.display = 'none'; el.setAttribute('aria-hidden', 'true'); }
      function esc(s) { return String(s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
      function notify(msg, color = 'var(--good)') { els.txMsg.style.color = color; els.txMsg.textContent = msg; setTimeout(() => { if (els.txMsg.textContent === msg) els.txMsg.textContent = ''; }, 3000); }

      // Theme
      (function applyTheme() {
        const t = localStorage.getItem(KEY_THEME) || 'dark';
        if (t === 'light') document.body.style.background = 'linear-gradient(1200px 600px at 10% 10%, rgba(240,244,248,0.45), rgba(250,250,250,0.7)), url("2.png") center/cover no-repeat fixed';
      })();
      document.getElementById('themeBtn').addEventListener('click', () => {
        const cur = localStorage.getItem(KEY_THEME) || 'dark';
        const next = cur === 'dark' ? 'light' : 'dark';
        localStorage.setItem(KEY_THEME, next);
        document.body.style.background = next === 'light' ? 'linear-gradient(1200px 600px at 10% 10%, rgba(240,244,248,0.45), rgba(250,250,250,0.7)), url("2.png") center/cover no-repeat fixed' : 'radial-gradient(1200px 600px at 10% 10%, rgba(20,34,46,0.18), rgba(3,6,10,0.7)), url("2.png") center/cover no-repeat fixed';
      });

      // Admin Login/Logout
      els.adminBtn.addEventListener('click', () => {
        if (isAdmin) {
          if (!confirm('Logout as admin?')) return;
          setAdmin(false); notify('Admin logged out', 'var(--muted)'); return;
        }
        els.adminPassword.value = '';
        openModal(els.adminModal);
        setTimeout(() => els.adminPassword.focus(), 120);
      });
      els.adminCancel.addEventListener('click', () => closeModal(els.adminModal));
      els.adminConfirm.addEventListener('click', () => {
        const p = (els.adminPassword.value || '').trim();
        if (!ADMIN_PASSWORDS.includes(p)) { alert('Incorrect password'); return; }
        closeModal(els.adminModal);
        setAdmin(true);
        notify('Admin logged in', 'var(--good)');
      });

      function applyAdminUI() {
        if (isAdmin) {
          els.addPanel.classList.add('admin-active');
          els.adminBadgeWrap.innerHTML = '<span style="display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#042;font-weight:800">ADMIN</span>';
          els.chartsPanel.classList.add('show'); els.chartsPanel.removeAttribute('aria-hidden');
          els.txTable.classList.add('show');
          els.txFold.classList.remove('collapsed');
        } else {
          els.addPanel.classList.remove('admin-active'); els.adminBadgeWrap.innerHTML = '';
          els.chartsPanel.classList.remove('show'); els.chartsPanel.setAttribute('aria-hidden', 'true');
          els.txTable.classList.remove('show');
          els.txFold.classList.add('collapsed');
        }
        els.addBtn.disabled = !isAdmin;
        renderTransactions();
      }

      // Foldable Transactions
      els.txFold.addEventListener('click', () => {
        els.txFold.classList.toggle('collapsed');
        els.txTable.classList.toggle('show');
      });

      // Back to Top
      window.addEventListener('scroll', () => {
        els.backToTop.classList.toggle('show', window.scrollY > 300);
      });
      els.backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

      // Firebase Sync
      txRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) { transactions = Object.keys(data).map(key => ({ key, ...data[key] })); saveLocal(); }
        renderTransactions();
      }, (error) => {
        console.error('Firebase error:', error);
        usingFirebase = false;
        transactions = JSON.parse(localStorage.getItem(KEY_TX) || "[]");
        renderTransactions();
        notify('Using local storage', 'var(--danger)');
      });

      // Add / Edit / Delete (unchanged logic)
      els.addBtn.addEventListener('click', () => { /* ... same as before */ });
      els.clearBtn.addEventListener('click', () => { els.txDate.value = ''; els.txAmount.value = ''; els.txNotes.value = ''; });
      function openEdit(key) { /* ... */ }
      function deleteTx(key) { /* ... */ }

      // Filters & Render
      els.applyFilter.addEventListener('click', renderTransactions);
      els.resetFilter.addEventListener('click', () => { els.fMonth.value = ''; els.fType.value = ''; els.fCategory.value = ''; els.fMin.value = ''; els.fMax.value = ''; els.fNotes.value = ''; renderTransactions(); });
      function passesFilters(t) { /* ... */ }
      function renderTransactions() {
        els.txTbody.innerHTML = '';
        let inc = 0, exp = 0;
        transactions.filter(passesFilters).forEach(t => {
          const tr = document.createElement('tr');
          const actions = [`<button class="action-btn" data-act="rcpt" data-key="${t.key}">Receipt</button>`];
          if (isAdmin) {
            actions.unshift(`<button class="action-btn" data-act="edit" data-key="${t.key}">Edit</button>`);
            actions.push(`<button class="delete-btn" data-act="del" data-key="${t.key}">Delete</button>`);
          }
          tr.innerHTML = `<td>${esc(t.date)}</td><td>${esc(t.type)}</td><td>${esc(t.category)}</td><td>KES ${t.amount.toLocaleString()}</td><td>${esc(t.notes || '')}</td><td>${actions.join(' ')}</td>`;
          els.txTbody.appendChild(tr);
          if (t.type === 'Income') inc += t.amount;
          if (t.type === 'Expense') exp += t.amount;
        });
        els.statIncome.textContent = inc.toLocaleString();
        els.statExpense.textContent = exp.toLocaleString();
        els.statBalance.textContent = (inc - exp).toLocaleString();
        if (isAdmin) renderCharts();
      }

      // Charts, Export, P&L, Receipt (unchanged)
      function renderCharts() { /* ... */ }
      els.exportCsv.addEventListener('click', () => { /* ... */ });
      function generatePL() {
        const m = els.reportMonth.value;
        const arr = m ? transactions.filter(t => t.date.startsWith(m)) : transactions;
        const inc = arr.filter(t => t.type === 'Income').reduce((a, b) => a + b.amount, 0);
        const exp = arr.filter(t => t.type === 'Expense').reduce((a, b) => a + b.amount, 0);
        const br = {};
        arr.forEach(t => br[t.category] = (br[t.category] || 0) + t.amount);
        let html = `<strong>Period:</strong> ${m || 'All'}<br><strong>Income:</strong> KES ${inc.toLocaleString()}<br><strong>Expense:</strong> KES ${exp.toLocaleString()}<br><strong>Net:</strong> KES ${(inc - exp).toLocaleString()}<div style="margin-top:8px"><strong>Category Breakdown:</strong><ul style="margin:0;padding-left:20px">`;
        for (const k in br) html += `<li>${k}: KES ${br[k].toLocaleString()}</li>`;
        html += '</ul></div>';
        els.plView.innerHTML = html;
        els.receiptInner.innerHTML = `<div class="receipt">${html}<div style="text-align:right;margin-top:10px"><button id="closePL" class="btn btn-ghost">Close</button></div></div>`;
        setTimeout(() => {
          document.getElementById('closePL')?.addEventListener('click', () => {
            closeModal(els.receiptModal);
            els.plView.innerHTML = ''; // Clear P&L view after closing
          });
        }, 50);
      }
      els.genPL.addEventListener('click', generatePL);
      els.showPLBtn.addEventListener('click', () => { generatePL(); openModal(els.receiptModal); });
      els.downloadPL.addEventListener('click', () => { /* ... */ });
      function openReceipt(key) { /* ... */ }

      // Init
      applyAdminUI();
      window.addEventListener('beforeunload', saveLocal);
    });
  </script>
</body>
  </html>
