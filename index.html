<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selelo Business Smart Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f4f7f6;color:#1c1c1c;transition:0.3s;}
body.dark{background:#121212;color:#fff;}
h1,h2,h3{text-align:center;margin:10px 0;font-weight:600;}
h2{font-size:1.5em;}
h3{font-size:1.2em;}
.container{max-width:1000px;margin:20px auto;padding:20px;background:#fff;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);transition:0.3s;}
body.dark .container{background:#1e1e1e;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
label{display:block;margin:10px 0 5px;font-weight:500;}
input,select,textarea{width:100%;padding:10px;margin-bottom:15px;border-radius:10px;border:1px solid #ccc;font-size:1em;}
body.dark input,body.dark select,body.dark textarea{background:#333;border:1px solid #555;color:#fff;}
button{padding:12px 25px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:0.2s;}
button:hover{opacity:0.9;}
.btn-add{background:#4CAF50;color:#fff;}
.btn-export{background:#2196F3;color:#fff;}
.btn-theme{background:#FF9800;color:#fff;margin-bottom:15px;}
.dashboard{display:flex;flex-wrap:wrap;justify-content:space-between;margin-top:20px;}
.card{background:#f7f7f7;flex:1 1 30%;margin:10px;padding:15px;border-radius:12px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.05);transition:0.3s;}
body.dark .card{background:#2c2c2c;box-shadow:0 2px 12px rgba(0,0,0,0.5);}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:0.95em;border-radius:10px;overflow:hidden;}
th,td{border-bottom:1px solid #ccc;padding:12px;text-align:left;}
th{background:#f0f0f0;font-weight:600;}
body.dark th{background:#333;color:#fff;}
body.dark td{border-color:#555;}
canvas{margin-top:25px;border-radius:15px;background:#fff;padding:10px;}
body.dark canvas{background:#2c2c2c;}
input[type="month"]{max-width:300px;margin:auto;display:block;}
#reportDiv{margin-top:20px;padding:15px;border-radius:12px;background:#f7f7f7;box-shadow:0 2px 12px rgba(0,0,0,0.05);}
body.dark #reportDiv{background:#2c2c2c;}
#transactionMessage{margin:10px 0;font-weight:600;text-align:center;color:#4CAF50;}
/* Modal styles */
.modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5);}
.modal-content{background:#fff;margin:15% auto;padding:20px;border-radius:12px;width:90%;max-width:400px;}
body.dark .modal-content{background:#2c2c2c;color:#fff;}
.modal-content input{margin-bottom:10px;}
.modal-buttons{text-align:right;}
.modal-buttons button{margin-left:10px;}
@media(max-width:768px){.dashboard{flex-direction:column;}.card{flex:1 1 100%;}}
.filter-panel{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;}
.filter-panel input, .filter-panel select{flex:1 1 150px;}
.budget-alert{color:#FF5252;font-weight:600;margin:10px 0;text-align:center;}
</style>
</head>
<body>
<div class="container">
  <h1>Selelo Business Smart Tracker</h1>
  <button id="themeBtn" class="btn-theme">Toggle Dark/Light Theme</button>

  <!-- Transaction Form -->
  <h2>Add Transaction</h2>
  <label for="date">Date</label>
  <input type="date" id="date" required>

  <label for="type">Transaction Type</label>
  <select id="type">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>

  <label for="category">Category</label>
  <select id="category">
    <option value="Sales">Sales</option>
    <option value="Other Income">Other Income</option>
    <option value="Food">Food</option>
    <option value="Transport">Transport</option>
    <option value="Supplies">Supplies</option>
    <option value="Other Expense">Other Expense</option>
  </select>

  <label for="amount">Amount</label>
  <input type="number" id="amount" placeholder="0" required>

  <label for="notes">Notes (optional)</label>
  <textarea id="notes" placeholder="Enter details about this transaction..."></textarea>

  <button id="addBtn" class="btn-add">Add Transaction</button>
  <div id="transactionMessage"></div>
  <div id="budgetAlert" class="budget-alert"></div>

  <!-- Budget Management -->
  <h2>Set Category Budgets</h2>
  <div id="budgetContainer"></div>

  <!-- Advanced Filter Panel -->
  <h2>Search / Filter Transactions</h2>
  <div class="filter-panel">
    <input type="month" id="filterMonth" placeholder="Filter by month">
    <select id="filterType">
      <option value="">All Types</option>
      <option value="Income">Income</option>
      <option value="Expense">Expense</option>
    </select>
    <select id="filterCategory">
      <option value="">All Categories</option>
      <option value="Sales">Sales</option>
      <option value="Other Income">Other Income</option>
      <option value="Food">Food</option>
      <option value="Transport">Transport</option>
      <option value="Supplies">Supplies</option>
      <option value="Other Expense">Other Expense</option>
    </select>
    <input type="number" id="filterMinAmount" placeholder="Min Amount">
    <input type="number" id="filterMaxAmount" placeholder="Max Amount">
    <input type="text" id="filterNotes" placeholder="Notes contains...">
    <button id="filterBtn" class="btn-theme">Apply Filter</button>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">
    <div class="card">
      <h3>Total Income</h3>
      <p id="totalIncome">0</p>
    </div>
    <div class="card">
      <h3>Total Expenses</h3>
      <p id="totalExpense">0</p>
    </div>
    <div class="card">
      <h3>Balance</h3>
      <p id="balance">0</p>
    </div>
  </div>

  <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
  <canvas id="categoryChart" width="400" height="200"></canvas>
  <canvas id="monthlyTrendChart" width="400" height="200"></canvas>

  <button id="exportBtn" class="btn-export">Export Transactions CSV</button>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Notes</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="transactionTable"></tbody>
  </table>

  <!-- Monthly Report -->
  <h2>Monthly Profit & Loss Statement</h2>
  <input type="month" id="reportMonth">
  <button id="reportDownloadBtn" class="btn-export">Download PDF</button>
  <div id="reportDiv">
    <h3 id="reportTitle"></h3>
    <p id="reportIncome"></p>
    <p id="reportExpense"></p>
    <p id="reportBalance"></p>
    <div id="reportCategoryBreakdown"></div>
  </div>
</div>

<!-- Admin Password Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <h3>Enter Admin Password</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter your admin password">
    <div class="modal-buttons">
      <button id="cancelModalBtn">Cancel</button>
      <button id="confirmModalBtn">Confirm</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ----- JavaScript: Phase 2 features included -----
let transactions = JSON.parse(localStorage.getItem('transactions'))||[];
let budgets = JSON.parse(localStorage.getItem('budgets'))||{};
let isDark=false;
const adminPasswords=["0742147197","+254 721 235005"];
let tempAction=null,tempIndex=null;

// Elements
const themeBtn=document.getElementById('themeBtn');
const addBtn=document.getElementById('addBtn');
const exportBtn=document.getElementById('exportBtn');
const reportDownloadBtn=document.getElementById('reportDownloadBtn');
const filterMonth=document.getElementById('filterMonth');
const filterType=document.getElementById('filterType');
const filterCategory=document.getElementById('filterCategory');
const filterMinAmount=document.getElementById('filterMinAmount');
const filterMaxAmount=document.getElementById('filterMaxAmount');
const filterNotes=document.getElementById('filterNotes');
const filterBtn=document.getElementById('filterBtn');
const reportMonth=document.getElementById('reportMonth');
const adminModal=document.getElementById('adminModal');
const adminPasswordInput=document.getElementById('adminPasswordInput');
const cancelModalBtn=document.getElementById('cancelModalBtn');
const confirmModalBtn=document.getElementById('confirmModalBtn');
const budgetContainer=document.getElementById('budgetContainer');
const budgetAlert=document.getElementById('budgetAlert');

// ----- Theme toggle -----
themeBtn.addEventListener('click',()=>{isDark=!isDark;document.body.classList.toggle('dark',isDark);});

// ----- Admin modal -----
cancelModalBtn.addEventListener('click',()=>{adminModal.style.display='none';adminPasswordInput.value='';tempAction=null;tempIndex=null;});
confirmModalBtn.addEventListener('click',()=>{handleAdminConfirm();});

// ----- Buttons -----
addBtn.addEventListener('click',()=>{tempAction='add';showAdminModal();});
exportBtn.addEventListener('click',exportCSV);
reportDownloadBtn.addEventListener('click',downloadPDF);
filterBtn.addEventListener('click',renderTransactions);
filterMonth.addEventListener('change',renderTransactions);
reportMonth.addEventListener('change',generateReport);

// ----- Admin modal functions -----
function showAdminModal(){adminModal.style.display='block';adminPasswordInput.focus();}
function handleAdminConfirm(){
  const pass=adminPasswordInput.value.trim();
  if(!adminPasswords.includes(pass)){alert("Incorrect password.");return;}
  adminModal.style.display='none';adminPasswordInput.value='';
  if(tempAction==='add')processAddTransaction();
  if(tempAction==='delete')processDeleteTransaction(tempIndex);
  if(tempAction==='edit')processEditTransaction(tempIndex);
  if(tempAction==='setBudget')saveBudgets();
  tempAction=null;tempIndex=null;
}

// ----- Budget management -----
const categories=['Sales','Other Income','Food','Transport','Supplies','Other Expense'];
function renderBudgetInputs(){
  budgetContainer.innerHTML='';
  categories.forEach(cat=>{
    const div=document.createElement('div');
    div.innerHTML=`<label>${cat} Budget:</label><input type="number" id="budget_${cat}" value="${budgets[cat]||''}" placeholder="0">`;
    budgetContainer.appendChild(div);
  });
  const btn=document.createElement('button');btn.textContent='Save Budgets';btn.className='btn-theme';
  btn.addEventListener('click',()=>{tempAction='setBudget';showAdminModal();});
  budgetContainer.appendChild(btn);
}
function saveBudgets(){
  categories.forEach(cat=>{budgets[cat]=parseFloat(document.getElementById(`budget_${cat}`).value)||0;});
  localStorage.setItem('budgets',JSON.stringify(budgets));
  alert('Budgets saved.');
  renderTransactions();
}

// ----- Transaction functions -----
function showTransactionMessage(t){
  const msgDiv=document.getElementById('transactionMessage');
  msgDiv.innerText=`Transaction ${t.action||'Added'}: ${t.type} – ${t.category} – ${t.amount}`;
  setTimeout(()=>{msgDiv.innerText='';},4000);
}
function checkBudgetAlert(){
  if(!Object.keys(budgets).length){budgetAlert.innerText='';return;}
  let alertMsg='';
  categories.forEach(cat=>{
    const spent=transactions.filter(t=>t.type==='Expense' && t.category===cat).reduce((a,b)=>a+b.amount,0);
    if(budgets[cat] && spent>budgets[cat]){alertMsg+=`Budget exceeded for ${cat}! `;}
  });
  budgetAlert.innerText=alertMsg;
}
function processAddTransaction(){
  const date=document.getElementById('date').value;
  const type=document.getElementById('type').value;
  const category=document.getElementById('category').value;
  const amount=parseFloat(document.getElementById('amount').value);
  const notes=document.getElementById('notes').value;
  if(!date||!amount){alert("Please fill date and amount");return;}
  transactions.push({date,type,category,amount,notes});
  localStorage.setItem('transactions',JSON.stringify(transactions));
  renderTransactions();
  showTransactionMessage({type,category,amount});
  document.getElementById('date').value='';document.getElementById('amount').value='';document.getElementById('notes').value='';
}

// ----- Delete/Edit Transactions -----
function deleteTransaction(index){tempAction='delete';tempIndex=index;showAdminModal();}
function processDeleteTransaction(index){if(confirm("Delete this transaction?")){transactions.splice(index,1);localStorage.setItem('transactions',JSON.stringify(transactions));renderTransactions();}}
function editTransaction(index){tempAction='edit';tempIndex=index;showAdminModal();}
function processEditTransaction(index){
  const t=transactions[index];
  const newDate=prompt("Edit Date:",t.date)||t.date;
  const newType=prompt("Edit Type (Income/Expense):",t.type)||t.type;
  const newCategory=prompt("Edit Category:",t.category)||t.category;
  const newAmount=parseFloat(prompt("Edit Amount:",t.amount))||t.amount;
  const newNotes=prompt("Edit Notes:",t.notes)||t.notes;
  transactions[index]={date:newDate,type:newType,category:newCategory,amount:newAmount,notes:newNotes};
  localStorage.setItem('transactions',JSON.stringify(transactions));
  renderTransactions();
  showTransactionMessage({...transactions[index],action:'Edited'});
}

// ----- Render Transactions Table -----
function renderTransactions(){
  const table=document.getElementById('transactionTable');
  table.innerHTML='';
  const fMonth=filterMonth.value;
  const fType=filterType.value;
  const fCat=filterCategory.value;
  const fMin=parseFloat(filterMinAmount.value)||0;
  const fMax=parseFloat(filterMaxAmount.value)||Infinity;
  const fNotes=filterNotes.value.toLowerCase();
  let totalIncome=0,totalExpense=0;
  transactions.forEach((t,i)=>{
    if(fMonth && !t.date.startsWith(fMonth))return;
    if(fType && t.type!==fType)return;
    if(fCat && t.category!==fCat)return;
    if(t.amount<fMin || t.amount>fMax)return;
    if(fNotes && !(t.notes||'').toLowerCase().includes(fNotes))return;
    const row=document.createElement('tr');
    row.innerHTML=`<td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.amount}</td><td>${t.notes||''}</td>
      <td>
        <button style="background:#FFC107;color:#000;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;" onclick="editTransaction(${i})">Edit</button>
        <button style="background:#FF5252;color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;" onclick="deleteTransaction(${i})">Delete</button>
      </td>`;
    table.appendChild(row);
    if(t.type==='Income')totalIncome+=t.amount;
    if(t.type==='Expense')totalExpense+=t.amount;
  });
  document.getElementById('totalIncome').innerText=totalIncome;
  document.getElementById('totalExpense').innerText=totalExpense;
  document.getElementById('balance').innerText=totalIncome-totalExpense;
  checkBudgetAlert();
  renderCharts();
}

// ----- Charts -----
function renderCharts(){
  const income=transactions.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense=transactions.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  renderDoughnut('incomeExpenseChart',['Income','Expenses'],[income,expense],['#4CAF50','#FF5252']);
  const categoriesCount={};
  transactions.forEach(t=>categoriesCount[t.category]=(categoriesCount[t.category]||0)+t.amount);
  renderDoughnut('categoryChart',Object.keys(categoriesCount),Object.values(categoriesCount));
  const months={};
  transactions.forEach(t=>{const m=t.date.slice(0,7);months[m]=months[m]||{Income:0,Expense:0};months[m][t.type]+=t.amount;});
  const monthKeys=Object.keys(months).sort();
  renderLine('monthlyTrendChart',monthKeys,monthKeys.map(m=>months[m].Income),monthKeys.map(m=>months[m].Expense));
}
function renderDoughnut(id,labels,data,colors){
  const ctx=document.getElementById(id).getContext('2d');
  if(window[id])window[id].destroy();
  window[id]=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors||['#4CAF50','#FF5252','#FFC107','#03A9F4','#9C27B0','#FF5722']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}
function renderLine(id,labels,income,expense){
  const ctx=document.getElementById(id).getContext('2d');
  if(window[id])window[id].destroy();
  window[id]=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Income',data:income,borderColor:'#4CAF50',backgroundColor:'rgba(76,175,80,0.2)',tension:0.3},{label:'Expense',data:expense,borderColor:'#FF5252',backgroundColor:'rgba(255,82,82,0.2)',tension:0.3}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

// ----- CSV Export -----
function exportCSV(){
  if(!transactions.length){alert("No transactions to export.");return;}
  let csv='Date,Type,Category,Amount,Notes\n';
  transactions.forEach(t=>{csv+=`"${t.date}","${t.type}","${t.category}","${t.amount}","${t.notes||''}"\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='transactions.csv';document.body.appendChild(a);a.click();a.remove();
}

// ----- Monthly Report -----
function generateReport(){
  const month=reportMonth.value;
  if(!month)return;
  const filtered=transactions.filter(t=>t.date.startsWith(month));
  const income=filtered.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense=filtered.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  document.getElementById('reportTitle').innerText=`Report for ${month}`;
  document.getElementById('reportIncome').innerText=`Total Income: ${income}`;
  document.getElementById('reportExpense').innerText=`Total Expense: ${expense}`;
  document.getElementById('reportBalance').innerText=`Balance: ${income-expense}`;
  let html='<h4>Category Breakdown:</h4><ul>';
  const breakdown={};
  filtered.forEach(t=>breakdown[t.category]=(breakdown[t.category]||0)+t.amount);
  for(let k in breakdown){html+=`<li>${k}: ${breakdown[k]}</li>`;}
  html+='</ul>';
  document.getElementById('reportCategoryBreakdown').innerHTML=html;
}

// ----- Download PDF -----
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.setFontSize(16); doc.text("Monthly Profit & Loss Report",10,20);
  doc.setFontSize(12);
  doc.text(document.getElementById('reportTitle').innerText,10,30);
  doc.text(document.getElementById('reportIncome').innerText,10,40);
  doc.text(document.getElementById('reportExpense').innerText,10,50);
  doc.text(document.getElementById('reportBalance').innerText,10,60);
  let y=70;
  document.querySelectorAll('#reportCategoryBreakdown ul li').forEach(i=>{doc.text(i.innerText,10,y);y+=10;});
  doc.save('Monthly_Report.pdf');
}

// ----- Initialize -----
renderBudgetInputs();
renderTransactions();
</script>
</body>
</html>
