<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selelo Business Smart Tracker</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f4f7f6;color:#1c1c1c;transition:0.3s;}
  body.dark{background:#121212;color:#fff;}
  h1,h2,h3{text-align:center;margin:10px 0;font-weight:600;}
  h2{font-size:1.5em;}
  h3{font-size:1.2em;}
  .container{max-width:1000px;margin:20px auto;padding:20px;background:#fff;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);transition:0.3s;}
  body.dark .container{background:#1e1e1e;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
  label{display:block;margin:10px 0 5px;font-weight:500;}
  input,select{width:100%;padding:10px;margin-bottom:15px;border-radius:10px;border:1px solid #ccc;font-size:1em;}
  body.dark input,body.dark select{background:#333;border:1px solid #555;color:#fff;}
  button{padding:12px 25px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:0.2s;}
  button:hover{opacity:0.9;}
  .btn-add{background:#4CAF50;color:#fff;}
  .btn-export{background:#2196F3;color:#fff;}
  .btn-theme{background:#FF9800;color:#fff;margin-bottom:15px;}
  .dashboard{display:flex;flex-wrap:wrap;justify-content:space-between;margin-top:20px;}
  .card{background:#f7f7f7;flex:1 1 30%;margin:10px;padding:15px;border-radius:12px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.05);transition:0.3s;}
  body.dark .card{background:#2c2c2c;box-shadow:0 2px 12px rgba(0,0,0,0.5);}
  table{width:100%;border-collapse:collapse;margin-top:20px;font-size:0.95em;border-radius:10px;overflow:hidden;}
  th,td{border-bottom:1px solid #ccc;padding:12px;text-align:left;}
  th{background:#f0f0f0;font-weight:600;}
  body.dark th{background:#333;color:#fff;}
  body.dark td{border-color:#555;}
  canvas{margin-top:25px;border-radius:15px;background:#fff;padding:10px;}
  body.dark canvas{background:#2c2c2c;}
  input[type="month"]{max-width:300px;margin:auto;display:block;}
  #reportDiv{margin-top:20px;padding:15px;border-radius:12px;background:#f7f7f7;box-shadow:0 2px 12px rgba(0,0,0,0.05);}
  body.dark #reportDiv{background:#2c2c2c;}
  #transactionMessage{margin:10px 0;font-weight:600;text-align:center;color:#4CAF50;}
  @media(max-width:768px){.dashboard{flex-direction:column;}.card{flex:1 1 100%;}}
</style>
</head>
<body>
<div class="container">
  <h1>Selelo Business Smart Tracker</h1>
  <button id="themeBtn" class="btn-theme">Toggle Dark/Light Theme</button>

  <h2>Add Transaction</h2>
  <label for="date">Date</label>
  <input type="date" id="date" required>

  <label for="type">Transaction Type</label>
  <select id="type">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>

  <label for="category">Category</label>
  <select id="category">
    <option value="Sales">Sales</option>
    <option value="Other Income">Other Income</option>
    <option value="Food">Food</option>
    <option value="Transport">Transport</option>
    <option value="Supplies">Supplies</option>
    <option value="Other Expense">Other Expense</option>
  </select>

  <label for="amount">Amount</label>
  <input type="number" id="amount" placeholder="0" required>

  <button id="addBtn" class="btn-add">Add Transaction</button>
  <div id="transactionMessage"></div>

  <h2>Filter by Month</h2>
  <input type="month" id="filterMonth">

  <div class="dashboard">
    <div class="card">
      <h3>Total Income</h3>
      <p id="totalIncome">0</p>
    </div>
    <div class="card">
      <h3>Total Expenses</h3>
      <p id="totalExpense">0</p>
    </div>
    <div class="card">
      <h3>Balance</h3>
      <p id="balance">0</p>
    </div>
  </div>

  <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
  <canvas id="categoryChart" width="400" height="200"></canvas>
  <canvas id="monthlyTrendChart" width="400" height="200"></canvas>

  <button id="exportBtn" class="btn-export">Export Transactions CSV</button>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="transactionTable"></tbody>
  </table>

  <h2>Monthly Profit & Loss Statement</h2>
  <input type="month" id="reportMonth">
  <button id="reportDownloadBtn" class="btn-export">Download PDF</button>
  <div id="reportDiv">
    <h3 id="reportTitle"></h3>
    <p id="reportIncome"></p>
    <p id="reportExpense"></p>
    <p id="reportBalance"></p>
    <div id="reportCategoryBreakdown"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let transactions = JSON.parse(localStorage.getItem('transactions'))||[];
let isDark=false;
const adminPasswords=["0742147197","+254 721 235005"];

// Button Event Listeners
document.getElementById('themeBtn').addEventListener('click', ()=>{isDark=!isDark;document.body.classList.toggle('dark',isDark);});
document.getElementById('addBtn').addEventListener('click', addTransaction);
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('reportDownloadBtn').addEventListener('click', downloadPDF);
document.getElementById('filterMonth').addEventListener('change', renderTransactions);
document.getElementById('reportMonth').addEventListener('change', generateReport);

// Show transaction message
function showTransactionMessage(t){
  const msgDiv = document.getElementById('transactionMessage');
  msgDiv.innerText = `Transaction Added: ${t.type} – ${t.category} – ${t.amount}`;
  setTimeout(()=>{ msgDiv.innerText=''; },4000);
}

// Add Transaction
function addTransaction(){
  const pass=prompt("Enter your admin password:");
  if(!pass||!adminPasswords.includes(pass.trim())){alert("Incorrect password.");return;}
  const date=document.getElementById('date').value;
  const type=document.getElementById('type').value;
  const category=document.getElementById('category').value;
  const amount=parseFloat(document.getElementById('amount').value);
  if(!date||!amount){alert("Please fill date and amount");return;}
  transactions.push({date,type,category,amount});
  localStorage.setItem('transactions',JSON.stringify(transactions));
  renderTransactions();
  showTransactionMessage({type,category,amount});
  document.getElementById('date').value='';document.getElementById('amount').value='';
}

// Delete Transaction
function deleteTransaction(index){
  const pass=prompt("Enter your admin password to delete:");
  if(!pass||!adminPasswords.includes(pass.trim())){alert("Incorrect password.");return;}
  if(confirm("Are you sure you want to delete this transaction?")){
    transactions.splice(index,1);
    localStorage.setItem('transactions',JSON.stringify(transactions));
    renderTransactions();
  }
}

// Render Transactions Table
function renderTransactions(){
  const table=document.getElementById('transactionTable');
  table.innerHTML='';
  const filter=document.getElementById('filterMonth').value;
  let totalIncome=0,totalExpense=0;
  transactions.forEach((t,i)=>{
    if(filter&&!t.date.startsWith(filter))return;
    const row=document.createElement('tr');
    row.innerHTML=`<td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.amount}</td>
      <td><button class="deleteBtn" data-index="${i}" style="background:#FF5252;color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;">Delete</button></td>`;
    table.appendChild(row);
    if(t.type==='Income')totalIncome+=t.amount;
    if(t.type==='Expense')totalExpense+=t.amount;
  });
  document.getElementById('totalIncome').innerText=totalIncome;
  document.getElementById('totalExpense').innerText=totalExpense;
  document.getElementById('balance').innerText=totalIncome-totalExpense;
  attachDeleteButtons();
  renderCharts();
}

// Attach Delete Button Listeners
function attachDeleteButtons(){
  document.querySelectorAll('.deleteBtn').forEach(btn=>{
    btn.addEventListener('click',()=>deleteTransaction(btn.getAttribute('data-index')));
  });
}

// Charts
function renderCharts(){
  const income=transactions.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense=transactions.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  renderDoughnut('incomeExpenseChart',['Income','Expenses'],[income,expense],['#4CAF50','#FF5252']);
  const categories={};
  transactions.forEach(t=>categories[t.category]=(categories[t.category]||0)+t.amount);
  renderDoughnut('categoryChart',Object.keys(categories),Object.values(categories));
  const months={};
  transactions.forEach(t=>{const m=t.date.slice(0,7);months[m]=months[m]||{Income:0,Expense:0};months[m][t.type]+=t.amount;});
  const monthKeys=Object.keys(months).sort();
  renderLine('monthlyTrendChart',monthKeys,monthKeys.map(m=>months[m].Income),monthKeys.map(m=>months[m].Expense));
}

function renderDoughnut(id,labels,data,colors){
  const ctx=document.getElementById(id).getContext('2d');
  if(window[id])window[id].destroy();
  window[id]=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors||['#4CAF50','#FF5252','#FFC107','#03A9F4','#9C27B0','#FF5722']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

function renderLine(id,labels,income,expense){
  const ctx=document.getElementById(id).getContext('2d');
  if(window[id])window[id].destroy();
  window[id]=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Income',data:income,borderColor:'#4CAF50',backgroundColor:'rgba(76,175,80,0.2)',tension:0.3},{label:'Expense',data:expense,borderColor:'#FF5252',backgroundColor:'rgba(255,82,82,0.2)',tension:0.3}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

// CSV Export
function exportCSV(){
  if(!transactions.length){alert("No transactions to export.");return;}
  let csv='Date,Type,Category,Amount\n';
  transactions.forEach(t=>{csv+=`"${t.date}","${t.type}","${t.category}","${t.amount}"\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='transactions.csv';document.body.appendChild(a);a.click();a.remove();
}

// Monthly Report
function generateReport(){
  const month=document.getElementById('reportMonth').value;
  if(!month)return;
  const filtered=transactions.filter(t=>t.date.startsWith(month));
  const income=filtered.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense=filtered.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  document.getElementById('reportTitle').innerText=`Report for ${month}`;
  document.getElementById('reportIncome').innerText=`Total Income: ${income}`;
  document.getElementById('reportExpense').innerText=`Total Expense: ${expense}`;
  document.getElementById('reportBalance').innerText=`Balance: ${income-expense}`;
  const breakdown={};
  filtered.forEach(t=>breakdown[t.category]=(breakdown[t.category]||0)+t.amount);
  let html='<h4>Category Breakdown:</h4><ul>';
  for(let k in breakdown){html+=`<li>${k}: ${breakdown[k]}</li>`;}
  html+='</ul>';
  document.getElementById('reportCategoryBreakdown').innerHTML=html;
}

// Download PDF
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.setFontSize(16); doc.text("Monthly Profit & Loss Report",10,20);
  doc.setFontSize(12);
  doc.text(document.getElementById('reportTitle').innerText,10,30);
  doc.text(document.getElementById('reportIncome').innerText,10,40);
  doc.text(document.getElementById('reportExpense').innerText,10,50);
  doc.text(document.getElementById('reportBalance').innerText,10,60);
  let y=70;
  document.querySelectorAll('#reportCategoryBreakdown ul li').forEach(i=>{doc.text(i.innerText,10,y);y+=10;});
  doc.save('Monthly_Report.pdf');
}

// Initial render
renderTransactions();
</script>
</body>
</html>
