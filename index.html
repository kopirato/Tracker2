<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selelo Business Smart Tracker</title>
<style>
:root{
  --accent:#1e88e5; --good:#4caf50; --danger:#ff5252; --card:#ffffffee;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter, "Segoe UI", system-ui, Arial, sans-serif;
  background: url('wallpaper.png') center/cover no-repeat fixed;
  -webkit-font-smoothing:antialiased;
  color:#111;
}
.overlay{
  min-height:100vh;
  background:rgba(255,255,255,0.95);
  backdrop-filter:blur(3px);
  padding:18px;
}
.app{
  max-width:1100px;margin:18px auto;padding:18px;border-radius:12px;
  background:linear-gradient(#ffffffcc,#fafafa);
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}
.header{display:flex;align-items:center;gap:14px;justify-content:center}
.logo{width:84px;height:84px;object-fit:contain;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
h1{margin:0;font-size:20px;text-align:center}
.controls{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px;font-weight:700}
.btn-accent{background:var(--accent);color:#fff}
.btn-primary{background:var(--good);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
label{display:block;margin-top:8px;font-weight:600;color:#333}
input,select,textarea{width:100%;padding:9px;border-radius:8px;border:1px solid #ddd;font-size:14px;margin-top:6px}
textarea{min-height:72px;resize:vertical}
.small{font-size:13px;color:#555;margin-top:6px}
.dashboard{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.stat{flex:1;padding:10px;border-radius:8px;background:#fff;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.04)}
.stat h4{margin:0;font-size:13px;color:#666}
.stat p{margin:8px 0 0;font-size:18px;font-weight:800}
.table-wrap{overflow:auto;margin-top:12px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
thead th{padding:10px;background:#fafafa;border-bottom:1px solid #eee;text-align:left;font-size:13px}
tbody td{padding:10px;border-bottom:1px solid #f3f3f3;font-size:13px}
.action-btn{padding:6px 8px;border-radius:6px;border:0;font-weight:700}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.filter-row > *{min-width:120px;flex:1}
.budget-alert{color:var(--danger);font-weight:800;text-align:center;margin-top:8px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center}
.modal .inner{width:94%;max-width:520px;background:#fff;padding:16px;border-radius:10px}
.receipt-content img{max-width:120px}
.footer{margin-top:14px;text-align:center;color:#444;font-size:13px}
.canvas{background:#fff;border-radius:8px;padding:8px;margin-top:12px}
.link-download{color:var(--accent);text-decoration:none;font-weight:700;margin-left:6px}
@media print{body *{visibility:hidden} .printable, .printable *{visibility:visible} .printable{position:fixed;left:0;top:0;width:100%}}
.show-hide{position:relative}
.show-hide button{position:absolute;right:8px;top:8px;padding:6px 8px;font-size:12px}
</style>
</head>
<body>
  <div class="overlay">
    <div class="app" role="application" aria-label="Selelo Business Smart Tracker">

      <div class="header">
        <img src="11.png" alt="Logo" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>Selelo Business Smart Tracker</h1>
          <div class="small">Upload <strong>logo.png</strong>, <strong>wallpaper.png</strong>, <strong>stamp.png</strong> to this repo folder — receipts include your stamp.</div>
        </div>
      </div>

      <div class="controls">
        <button id="themeBtn" class="btn-accent">Toggle Theme</button>
        <button id="exportCSVBtn" class="btn-accent">Export CSV</button>
        <button id="downloadPLPdfBtn" class="btn-accent">Download P&L PDF</button>
        <a href="logo.png" download class="link-download">Download Logo</a>
        <a href="wallpaper.png" download class="link-download">Download Wallpaper</a>
        <a href="stamp.png" download class="link-download">Download Stamp</a>
      </div>

      <div class="grid">
        <!-- Left column: Form + table -->
        <div>
          <div class="card" aria-labelledby="add-trans">
            <h2 id="add-trans">Add Transaction</h2>
            <label for="txDate">Date</label>
            <input id="txDate" type="date">

            <label for="txType">Type</label>
            <select id="txType"><option>Income</option><option>Expense</option></select>

            <label for="txCategory">Category</label>
            <select id="txCategory">
              <option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option>
            </select>

            <label for="txAmount">Amount</label>
            <input id="txAmount" type="number" min="0" step="0.01">

            <label for="txNotes">Notes (optional)</label>
            <textarea id="txNotes" placeholder="Describe the transaction"></textarea>

            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <button id="addBtn" class="btn-primary">Add (admin)</button>
              <button id="clearBtn">Clear</button>
            </div>
            <div id="txMsg" class="small" aria-live="polite" style="color:green;margin-top:8px"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Filters</h3>
            <div class="filter-row">
              <input id="fMonth" type="month" placeholder="Month">
              <select id="fType"><option value="">All Types</option><option>Income</option><option>Expense</option></select>
              <select id="fCategory"><option value="">All Categories</option><option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option></select>
              <input id="fMin" type="number" placeholder="Min">
              <input id="fMax" type="number" placeholder="Max">
              <input id="fNotes" type="text" placeholder="Notes contains">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="applyFilter" class="btn-accent">Apply</button>
              <button id="resetFilter">Reset</button>
            </div>

            <div class="table-wrap" style="margin-top:12px">
              <table aria-label="Transactions table">
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Notes</th><th>Action</th></tr></thead>
                <tbody id="txTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Right column: dashboard, budgets, charts, P&L -->
        <aside>
          <div class="card">
            <h3>Dashboard</h3>
            <div class="dashboard">
              <div class="stat"><h4>Total Income</h4><p id="statIncome">0</p></div>
              <div class="stat"><h4>Total Expense</h4><p id="statExpense">0</p></div>
              <div class="stat"><h4>Balance</h4><p id="statBalance">0</p></div>
            </div>
            <div id="budgetAlert" class="budget-alert" role="status" aria-live="polite"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Budgets</h3>
            <div id="budgetsArea"></div>
            <div style="margin-top:8px">
              <button id="saveBudgetsBtn" class="btn-accent">Save Budgets (admin)</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Charts</h3>
            <div class="canvas"><canvas id="chartIE" height="140"></canvas></div>
            <div class="canvas"><canvas id="chartCat" height="140"></canvas></div>
            <div class="canvas"><canvas id="chartTrend" height="140"></canvas></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Profit & Loss (P&L)</h3>
            <input id="reportMonth" type="month" style="margin-bottom:8px">
            <div style="display:flex;gap:8px">
              <button id="genPLBtn" class="btn-primary">Generate P&L</button>
              <button id="downloadPLBtn" class="btn-accent">Download P&L PDF</button>
            </div>
            <div id="plView" style="margin-top:12px;font-size:14px"></div>
          </div>
        </aside>
      </div>

      <div class="footer">Made for Selian — upload the images to this folder and they will load automatically.</div>
    </div>
  </div>

  <!-- Admin modal (show/hide) -->
  <div id="adminModal" class="modal" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="inner" role="document">
      <h3>Admin Password</h3>
      <p class="small">Enter admin password to proceed</p>
      <div style="position:relative">
        <input id="adminInput" type="password" placeholder="Admin password" style="padding-right:70px">
        <button id="toggleShow" style="position:absolute;right:6px;top:6px;padding:6px 8px;font-size:12px">Show</button>
      </div>
      <div style="text-align:right;margin-top:10px">
        <button id="adminCancel">Cancel</button>
        <button id="adminOk" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Edit modal (opened after admin confirm) -->
  <div id="editModal" class="modal" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="inner" role="document">
      <h3>Edit Transaction</h3>
      <label>Date</label><input id="editDate" type="date">
      <label>Type</label><select id="editType"><option>Income</option><option>Expense</option></select>
      <label>Category</label><select id="editCategory"><option>Sales</option><option>Other Income</option><option>Food</option><option>Transport</option><option>Supplies</option><option>Other Expense</option></select>
      <label>Amount</label><input id="editAmount" type="number">
      <label>Notes</label><textarea id="editNotes"></textarea>
      <div style="text-align:right;margin-top:8px">
        <button id="editCancel">Cancel</button>
        <button id="editSave" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Receipt modal -->
  <div id="receiptModal" class="modal" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="inner receipt-content" id="receiptInner" role="document"></div>
  </div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================= Configuration & State ================= */
const ADMIN_PASSWORDS = ["0742147197","0721235005"];
const STORAGE_TX = "sel_transactions_final_v1";
const STORAGE_BUDGETS = "sel_budgets_final_v1";

let transactions = JSON.parse(localStorage.getItem(STORAGE_TX) || "[]");
let budgets = JSON.parse(localStorage.getItem(STORAGE_BUDGETS) || "{}");
let pendingAdmin = null; // {action, payload}
let currentEditIndex = null;

/* ================= Element refs ================= */
const txDate = document.getElementById('txDate');
const txType = document.getElementById('txType');
const txCategory = document.getElementById('txCategory');
const txAmount = document.getElementById('txAmount');
const txNotes = document.getElementById('txNotes');
const addBtn = document.getElementById('addBtn');
const clearBtn = document.getElementById('clearBtn');
const txTbody = document.getElementById('txTbody');
const txMsg = document.getElementById('txMsg');

const fMonth = document.getElementById('fMonth');
const fType = document.getElementById('fType');
const fCategory = document.getElementById('fCategory');
const fMin = document.getElementById('fMin');
const fMax = document.getElementById('fMax');
const fNotes = document.getElementById('fNotes');
const applyFilterBtn = document.getElementById('applyFilter');
const resetFilterBtn = document.getElementById('resetFilter');

const statIncome = document.getElementById('statIncome');
const statExpense = document.getElementById('statExpense');
const statBalance = document.getElementById('statBalance');
const budgetAlert = document.getElementById('budgetAlert');

const budgetsArea = document.getElementById('budgetsArea');
const saveBudgetsBtn = document.getElementById('saveBudgetsBtn');

const chartIECtx = document.getElementById('chartIE').getContext('2d');
const chartCatCtx = document.getElementById('chartCat').getContext('2d');
const chartTrendCtx = document.getElementById('chartTrend').getContext('2d');
let chartIE, chartCat, chartTrend;

const genPLBtn = document.getElementById('genPLBtn');
const downloadPLBtn = document.getElementById('downloadPLBtn');
const plView = document.getElementById('plView');
const reportMonth = document.getElementById('reportMonth');

const exportCSVBtn = document.getElementById('exportCSVBtn');
const downloadPLPdfBtn = document.getElementById('downloadPLPdfBtn');

const adminModal = document.getElementById('adminModal');
const adminInput = document.getElementById('adminInput');
const adminCancel = document.getElementById('adminCancel');
const adminOk = document.getElementById('adminOk');
const toggleShow = document.getElementById('toggleShow');

const editModal = document.getElementById('editModal');
const editDate = document.getElementById('editDate');
const editType = document.getElementById('editType');
const editCategory = document.getElementById('editCategory');
const editAmount = document.getElementById('editAmount');
const editNotes = document.getElementById('editNotes');
const editCancel = document.getElementById('editCancel');
const editSave = document.getElementById('editSave');

const receiptModal = document.getElementById('receiptModal');
const receiptInner = document.getElementById('receiptInner');

const themeBtn = document.getElementById('themeBtn');

/* ================= Utilities ================= */
function saveTransactions(){ localStorage.setItem(STORAGE_TX, JSON.stringify(transactions)); }
function saveBudgets(){ localStorage.setItem(STORAGE_BUDGETS, JSON.stringify(budgets)); }

function showMsg(text, color='green'){
  txMsg.style.color = color; txMsg.textContent = text;
  setTimeout(()=>{ if(txMsg.textContent===text) txMsg.textContent=''; }, 3500);
}
function openModal(mod){ mod.style.display = 'flex'; mod.setAttribute('aria-hidden','false'); }
function closeModal(mod){ mod.style.display = 'none'; mod.setAttribute('aria-hidden','true'); }

/* close modal on outside click */
document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', (e)=> { if(e.target === m) closeModal(m); });
});

/* ================= Admin modal flow ================= */
function requireAdmin(action, payload){
  pendingAdmin = {action, payload};
  adminInput.value = '';
  adminInput.type = 'password';
  toggleShow.textContent = 'Show';
  openModal(adminModal);
}
adminCancel.addEventListener('click', ()=>{ pendingAdmin=null; closeModal(adminModal); });
toggleShow.addEventListener('click', ()=>{
  if(adminInput.type === 'password'){ adminInput.type = 'text'; toggleShow.textContent = 'Hide'; }
  else { adminInput.type = 'password'; toggleShow.textContent = 'Show'; }
});
adminOk.addEventListener('click', ()=>{
  const pass = adminInput.value.trim();
  if(!ADMIN_PASSWORDS.includes(pass)){ alert('Incorrect admin password'); return; }
  closeModal(adminModal);
  const action = pendingAdmin && pendingAdmin.action;
  const payload = pendingAdmin && pendingAdmin.payload;
  pendingAdmin = null;
  if(action === 'add') doAddTransaction();
  if(action === 'delete') doDeleteTransaction(payload.index);
  if(action === 'saveBudgets') doSaveBudgets();
  if(action === 'editOpen') openEditModal(payload.index);
  if(action === 'editSave') doSaveEdit(payload.payload);
});

/* ----------------- Add / Clear ----------------- */
addBtn.addEventListener('click', ()=> requireAdmin('add', null));
clearBtn.addEventListener('click', ()=>{ txDate.value=''; txAmount.value=''; txNotes.value=''; });

function doAddTransaction(){
  const date = txDate.value;
  const type = txType.value;
  const category = txCategory.value;
  const amount = parseFloat(txAmount.value);
  const notes = txNotes.value.trim();
  if(!date || !amount || isNaN(amount)){ alert('Enter a valid date and amount'); return; }
  transactions.push({date,type,category,amount,notes});
  saveTransactions();
  renderTransactions();
  showMsg(`Added: ${type} — ${category} — ${amount}`);
  txDate.value=''; txAmount.value=''; txNotes.value='';
}

/* ----------------- Edit flow ----------------- */
function requestEdit(index){ requireAdmin('editOpen', {index}); }
function openEditModal(index){
  currentEditIndex = index;
  const t = transactions[index];
  editDate.value = t.date; editType.value = t.type; editCategory.value = t.category;
  editAmount.value = t.amount; editNotes.value = t.notes || '';
  openModal(editModal);
}
editCancel.addEventListener('click', ()=>{ closeModal(editModal); currentEditIndex = null; });
editSave.addEventListener('click', ()=>{
  // prepare payload and require admin confirm to save
  const payload = {
    index: currentEditIndex,
    newData: {
      date: editDate.value,
      type: editType.value,
      category: editCategory.value,
      amount: parseFloat(editAmount.value),
      notes: editNotes.value || ''
    }
  };
  closeModal(editModal);
  requireAdmin('editSave', {payload});
});
function doSaveEdit(payloadObj){
  const idx = payloadObj.index;
  const nd = payloadObj.newData;
  if(idx==null || !nd || !nd.date || isNaN(nd.amount)){ alert('Invalid edit data'); return; }
  transactions[idx] = nd;
  saveTransactions();
  renderTransactions();
  showMsg('Transaction edited', 'green');
  currentEditIndex = null;
}

/* ----------------- Delete ----------------- */
function requestDelete(index){ requireAdmin('delete', {index}); }
function doDeleteTransaction(index){
  if(!confirm('Delete this transaction?')) return;
  transactions.splice(index,1);
  saveTransactions();
  renderTransactions();
  showMsg('Transaction deleted','red');
}

/* ----------------- Budgets ----------------- */
const CATS = ['Sales','Other Income','Food','Transport','Supplies','Other Expense'];
function renderBudgetInputs(){
  budgetsArea.innerHTML = '';
  CATS.forEach(cat=>{
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `<label style="font-weight:700">${cat} budget</label>
      <input type="number" id="budget_${cat}" placeholder="0" value="${budgets[cat]||''}">`;
    budgetsArea.appendChild(div);
  });
}
saveBudgetsBtn.addEventListener('click', ()=> requireAdmin('saveBudgets', null) );
function doSaveBudgets(){
  CATS.forEach(cat=>{
    const val = parseFloat(document.getElementById(`budget_${cat}`).value) || 0;
    budgets[cat] = val;
  });
  saveBudgets();
  renderTransactions();
  showMsg('Budgets saved','green');
}

/* ----------------- Filters & rendering ----------------- */
function passesFilters(t){
  if(fMonth.value && !t.date.startsWith(fMonth.value)) return false;
  if(fType.value && t.type !== fType.value) return false;
  if(fCategory.value && t.category !== fCategory.value) return false;
  const min = parseFloat(fMin.value) || -Infinity;
  const max = parseFloat(fMax.value) || Infinity;
  if(t.amount < min || t.amount > max) return false;
  const nf = (fNotes.value || '').toLowerCase();
  if(nf && !( (t.notes||'').toLowerCase().includes(nf) )) return false;
  return true;
}
applyFilterBtn.addEventListener('click', renderTransactions);
resetFilterBtn.addEventListener('click', ()=>{
  fMonth.value=''; fType.value=''; fCategory.value=''; fMin.value=''; fMax.value=''; fNotes.value=''; renderTransactions();
});

function renderTransactions(){
  txTbody.innerHTML = '';
  let totalIncome = 0, totalExpense = 0;
  transactions.forEach((t,i)=>{
    if(!passesFilters(t)) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td>
      <td>${t.type}</td>
      <td>${t.category}</td>
      <td>${t.amount.toLocaleString()}</td>
      <td>${(t.notes||'')}</td>
      <td>
        <button class="action-btn" data-action="edit" data-index="${i}" style="background:#ffc107">Edit</button>
        <button class="action-btn" data-action="delete" data-index="${i}" style="background:var(--danger);color:#fff">Delete</button>
        <button class="action-btn" data-action="receipt" data-index="${i}" style="background:#1976d2;color:#fff">Receipt</button>
      </td>`;
    txTbody.appendChild(tr);
    if(t.type === 'Income') totalIncome += t.amount;
    if(t.type === 'Expense') totalExpense += t.amount;
  });
  statIncome.textContent = totalIncome.toLocaleString();
  statExpense.textContent = totalExpense.toLocaleString();
  statBalance.textContent = (totalIncome - totalExpense).toLocaleString();
  checkBudgetAlerts();
  renderCharts();
}

/* delegation for table actions */
txTbody.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const act = btn.dataset.action; const idx = parseInt(btn.dataset.index);
  if(act === 'edit') requestEdit(idx);
  if(act === 'delete') requestDelete(idx);
  if(act === 'receipt') openReceipt(idx);
});

/* ----------------- Budget alerts ----------------- */
function checkBudgetAlerts(){
  let msg = '';
  CATS.forEach(cat=>{
    const spent = transactions.filter(t=>t.type==='Expense' && t.category===cat).reduce((a,b)=>a+b.amount,0);
    if(budgets[cat] && budgets[cat] > 0 && spent > budgets[cat]){
      msg += `Budget exceeded for ${cat} (spent ${spent.toLocaleString()} > ${budgets[cat].toLocaleString()}). `;
    }
  });
  budgetAlert.textContent = msg;
}

/* ----------------- Charts ----------------- */
function renderCharts(){
  const inc = transactions.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const exp = transactions.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  if(chartIE) chartIE.destroy();
  chartIE = new Chart(chartIECtx, { type:'doughnut', data:{labels:['Income','Expense'], datasets:[{data:[inc,exp], backgroundColor:['#4caf50','#ff5252']}]}, options:{responsive:true, plugins:{legend:{position:'bottom'}}}});
  const catMap = {};
  transactions.forEach(t=> catMap[t.category] = (catMap[t.category]||0)+t.amount );
  if(chartCat) chartCat.destroy();
  chartCat = new Chart(chartCatCtx,{ type:'doughnut', data:{labels:Object.keys(catMap), datasets:[{data:Object.values(catMap), backgroundColor:['#2196f3','#ffc107','#9c27b0','#03a9f4','#ff5722','#4caf50']}]}, options:{responsive:true, plugins:{legend:{position:'bottom'}}}});
  const monthly = {};
  transactions.forEach(t=>{ const m = t.date.slice(0,7); monthly[m] = monthly[m] || {Income:0,Expense:0}; monthly[m][t.type] += t.amount; });
  const months = Object.keys(monthly).sort();
  const incArr = months.map(m=>monthly[m].Income||0);
  const expArr = months.map(m=>monthly[m].Expense||0);
  if(chartTrend) chartTrend.destroy();
  chartTrend = new Chart(chartTrendCtx,{ type:'line', data:{ labels:months, datasets:[{label:'Income', data:incArr, borderColor:'#4caf50', fill:true, backgroundColor:'rgba(76,175,80,0.12)'},{label:'Expense', data:expArr, borderColor:'#ff5252', fill:true, backgroundColor:'rgba(255,82,82,0.12)'}]}, options:{responsive:true, plugins:{legend:{position:'bottom'}}, tension:0.3 }});
}

/* ----------------- Export CSV ----------------- */
exportCSVBtn.addEventListener('click', ()=>{
  if(!transactions.length){ alert('No transactions to export'); return; }
  let csv = 'Date,Type,Category,Amount,Notes\n';
  transactions.forEach(t=> csv += `"${t.date}","${t.type}","${t.category}","${t.amount}","${(t.notes||'').replace(/"/g,'""')}"\n`);
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'transactions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ----------------- P&L display + download ----------------- */
genPLBtn.addEventListener('click', generatePL);
downloadPLBtn.addEventListener('click', downloadPLPdf);
downloadPLPdfBtn.addEventListener('click', downloadPLPdf);

function generatePL(){
  const m = reportMonth.value;
  const arr = m ? transactions.filter(t=>t.date.startsWith(m)) : transactions.slice();
  const income = arr.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense = arr.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  const net = income - expense;
  let html = `<strong>Period:</strong> ${m||'All'}<br><strong>Total Income:</strong> ${income.toLocaleString()}<br><strong>Total Expense:</strong> ${expense.toLocaleString()}<br><strong>Net:</strong> ${net.toLocaleString()}`;
  const breakdown = {};
  arr.forEach(t=> breakdown[t.category] = (breakdown[t.category]||0)+t.amount);
  html += '<div style="margin-top:8px"><strong>Category:</strong><ul>';
  for(const k in breakdown) html += `<li>${k}: ${breakdown[k].toLocaleString()}</li>`;
  html += '</ul></div>';
  plView.innerHTML = html;
}

function downloadPLPdf(){
  const m = reportMonth.value;
  const arr = m ? transactions.filter(t=>t.date.startsWith(m)) : transactions.slice();
  const income = arr.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
  const expense = arr.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
  const net = income - expense;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16); doc.text('Selelo Business - Profit & Loss', 14, 20);
  doc.setFontSize(11); doc.text(`Period: ${m || 'All'}`, 14, 30);
  doc.text(`Total Income: ${income}`, 14, 42);
  doc.text(`Total Expense: ${expense}`, 14, 50);
  doc.text(`Net: ${net}`, 14, 58);
  let y = 70;
  doc.text('Category breakdown:', 14, y); y += 8;
  const breakdown = {};
  arr.forEach(t=> breakdown[t.category] = (breakdown[t.category]||0)+t.amount);
  for(const k in breakdown){
    doc.text(`${k}: ${breakdown[k]}`, 16, y); y += 8;
    if(y > 270){ doc.addPage(); y = 20; }
  }
  doc.save(`PL_${m || 'all'}.pdf`);
}

/* ----------------- Receipt / print ----------------- */
function openReceipt(index){
  const t = transactions[index];
  const inv = 'INV-' + (10000 + index);
  const issued = new Date().toLocaleDateString();
  const html = `
    <div class="printable" style="text-align:center;font-family:Arial,sans-serif;color:#000">
      <img src="logo.png" style="max-width:120px;margin-bottom:6px" onerror="this.style.display='none'"><h2>Selelo Business Receipt</h2>
      <div style="text-align:left;margin-top:8px;font-size:14px">
        <strong>Receipt No:</strong> ${inv}<br>
        <strong>Issued:</strong> ${issued}<br>
        <strong>Transaction Date:</strong> ${t.date}<br>
        <strong>Type:</strong> ${t.type}<br>
        <strong>Category:</strong> ${t.category}<br>
        <strong>Amount:</strong> KES ${t.amount}<br>
        <strong>Notes:</strong> ${t.notes || '-'}
      </div>
      <div style="margin-top:12px"><img src="stamp.png" style="max-width:140px;opacity:0.95" onerror="this.style.display='none'"></div>
      <div style="margin-top:12px">
        <button id="printReceiptBtn" style="padding:8px 12px;border-radius:8px;background:#111;color:#fff">Print</button>
        <button id="closeReceiptBtn" style="padding:8px 12px;border-radius:8px;margin-left:8px">Close</button>
      </div>
    </div>
  `;
  receiptInner.innerHTML = html;
  openModal(receiptModal);
  document.getElementById('printReceiptBtn').addEventListener('click', ()=>{
    const w = window.open('', '_blank', 'width=700,height=800');
    w.document.write('<html><head><title>Receipt</title></head><body>' + receiptInner.innerHTML + '</body></html>');
    w.document.close();
    setTimeout(()=>{ w.print(); }, 300);
  });
  document.getElementById('closeReceiptBtn').addEventListener('click', ()=> closeModal(receiptModal));
}

/* ----------------- Theme toggle ----------------- */
let dark = false;
themeBtn.addEventListener('click', ()=> {
  dark = !dark;
  if(dark){
    document.body.style.background = '#111';
    document.querySelector('.overlay').style.background = 'rgba(0,0,0,0.85)';
  } else {
    document.body.style.background = "url('wallpaper.png') center/cover no-repeat fixed";
    document.querySelector('.overlay').style.background = 'rgba(255,255,255,0.95)';
  }
});

/* ----------------- Init ----------------- */
function init(){
  renderBudgetInputs();
  renderTransactions();
  // ensure modals close on outside click (wired earlier)
}
init();

/* Save on unload */
window.addEventListener('beforeunload', ()=> { saveTransactions(); saveBudgets(); });
</script>
</body>
    </html>
